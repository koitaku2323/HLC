<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with LLM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #fff;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar h2 {
            text-align: center;
            padding: 15px;
            background-color: #007bff;
            color: #fff;
            margin: 0;
        }
        .new-chat-button {
            display: block;
            width: 90%;
            margin: 10px auto;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #28a745;
            color: #fff;
            cursor: pointer;
            text-align: center;
        }
        .new-chat-button:hover {
            background-color: #218838;
        }
        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chat-list li {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
        }
        .chat-list li:hover {
            background-color: #f0f0f0;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .chat-box {
            width: 100%;
            max-width: 800px;
            height: 60vh;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .input-area {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
        }
        .input-box {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
            resize: none;
        }
        .send-button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }
        .send-button:hover {
            background-color: #0056b3;
        }
        .upload-form {
            margin-bottom: 20px;
        }
        .upload-button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #28a745;
            color: #fff;
            cursor: pointer;
        }
        .upload-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Chats</h2>
        <button class="new-chat-button" onclick="createNewChat()">New Chat</button>
        <ul class="chat-list" id="chat-list"></ul>
    </div>
    <div class="chat-container">
        <form class="upload-form" id="upload-form" enctype="multipart/form-data">
            <input type="file" id="file" name="file" accept="application/pdf">
            <button type="submit" class="upload-button">Upload PDF</button>
        </form>
        <div class="chat-box" id="chat-box"></div>
        <div class="input-area">
            <textarea class="input-box" id="prompt" rows="3" placeholder="Type your message here..."></textarea>
            <button class="send-button" onclick="sendPrompt()">Send</button>
        </div>
    </div>

    <script>
        let currentChatId = '';
        const chatBox = document.getElementById('chat-box');
        const chatList = document.getElementById('chat-list');

        function loadChats() {
            fetch('/chats')
                .then(response => response.json())
                .then(data => {
                    chatList.innerHTML = '';
                    for (const chatId in data.chat_titles) {
                        const li = document.createElement('li');
                        li.textContent = data.chat_titles[chatId];
                        li.onclick = () => selectChat(chatId);
                        chatList.appendChild(li);
                    }
                });
        }

        function selectChat(chatId) {
            currentChatId = chatId;
            chatBox.innerHTML = '';
            fetch('/chats')
                .then(response => response.json())
                .then(data => {
                    const messages = data.chats[chatId] || [];
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.textContent = `${message.role === 'user' ? 'You' : 'AI'}: ${message.content}`;
                        chatBox.appendChild(messageDiv);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        async function createNewChat() {
            currentChatId = '';
            chatBox.innerHTML = '';
            document.getElementById('prompt').value = '';
        }

        document.getElementById('upload-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData();
            formData.append('file', document.getElementById('file').files[0]);
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            alert(data.success || data.error);
        });

        async function sendPrompt() {
            const prompt = document.getElementById('prompt').value;
            if (!currentChatId) {
                currentChatId = generateUUID();
            }
            const response = await fetch('/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `chat_id=${encodeURIComponent(currentChatId)}&prompt=${encodeURIComponent(prompt)}`
            });
            const data = await response.json();
            const userMessage = document.createElement('div');
            userMessage.textContent = `You: ${prompt}`;
            userMessage.style.fontWeight = 'bold';
            const aiMessage = document.createElement('div');
            aiMessage.textContent = `AI: ${data.response}`;
            aiMessage.style.marginTop = '10px';
            chatBox.appendChild(userMessage);
            chatBox.appendChild(aiMessage);
            document.getElementById('prompt').value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // Update chat list with new title if it's a new chat
            if (!document.querySelector(`li[data-chat-id="${currentChatId}"]`)) {
                const li = document.createElement('li');
                li.textContent = data.title;
                li.setAttribute('data-chat-id', currentChatId);
                li.onclick = () => selectChat(currentChatId);
                chatList.appendChild(li);
            }
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        loadChats();
    </script>
</body>
</html>


